<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç®„ÇØ„Çπ„Éù„Éº„Éà - {{.CurrentDatabase}} - {{.Server.Name}} - GoDB Admin</title>
    {{template "styles" .}}
    <style>
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50; }
        .form-group input[type="text"], .form-group select { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .form-group-inline { display: flex; align-items: center; gap: 0.5rem; }
        .form-group-inline input[type="checkbox"] { width: auto; }
        .table-selection { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; }
        .table-checkbox { display: flex; align-items: center; padding: 0.5rem; border-bottom: 1px solid #f5f5f5; }
        .table-checkbox:last-child { border-bottom: none; }
        .table-checkbox:hover { background: #f8f9fa; }
        .table-checkbox input { margin-right: 0.5rem; }
        .section-title { font-size: 1.1rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 1rem; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; }
    </style>
</head>
<body>
    {{template "header" .}}
    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <ul class="tree">
                <li class="server-item">
                    <div style="flex: 1;">
                        {{.Server.Name}}
                    </div>
                    <span class="toggle-icon" onclick="toggleServer(event)">‚ñº</span>
                </li>
                <ul class="database-list expanded" id="server-databases">
                    {{range $index, $dbWithTables := .DatabasesWithTables}}
                    <li class="tree-item database-item {{if eq $.CurrentDatabase .DatabaseName}}active{{end}}">
                        <a href="/servers/{{$.Server.ID}}/database?db={{.DatabaseName}}" style="text-decoration: none; color: inherit; flex: 1;">
                            {{.DatabaseName}}
                        </a>
                        {{if .Tables}}
                        <span class="toggle-icon" onclick="toggleDatabase(event, {{$index}})">{{if eq $.CurrentDatabase .DatabaseName}}‚ñº{{else}}‚ñ∂{{end}}</span>
                        {{end}}
                    </li>
                    {{if .Tables}}
                    <ul class="table-list {{if eq $.CurrentDatabase .DatabaseName}}expanded{{end}}" id="db-{{$index}}">
                        {{$dbName := .DatabaseName}}
                        {{range $table := .Tables}}
                        <li class="tree-item table-item">
                            <a href="/servers/{{$.Server.ID}}/db/{{$dbName}}/table/{{$table.TableName}}" style="text-decoration: none; color: inherit; display: block;">
                                {{$table.TableName}}
                            </a>
                        </li>
                        {{end}}
                    </ul>
                    {{end}}
                    {{end}}
                </ul>
            </ul>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="content">
            {{if .Error}}
            <div class="card" style="background: #fee; border-left: 4px solid #e74c3c;">
                <strong>„Ç®„É©„Éº:</strong> {{.Error}}
            </div>
            {{end}}

            <div class="card">
                <h2>üì• „Éá„Éº„Çø„Éô„Éº„Çπ„Ç®„ÇØ„Çπ„Éù„Éº„Éà</h2>
                <div class="breadcrumb">
                    <a href="/servers">„Çµ„Éº„Éê‰∏ÄË¶ß</a> /
                    <a href="/servers/{{.Server.ID}}/database">{{.Server.Name}}</a> /
                    <a href="/servers/{{.Server.ID}}/database?db={{.CurrentDatabase}}">{{.CurrentDatabase}}</a> /
                    „Ç®„ÇØ„Çπ„Éù„Éº„Éà
                </div>

                <form id="exportForm" method="POST" action="/servers/{{.Server.ID}}/db/{{.CurrentDatabase}}/export">
                    <div class="section-title">„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂØæË±°</div>

                    <div class="form-group">
                        <div class="form-group-inline">
                            <input type="checkbox" id="selectAll" onclick="toggleAllTables(this)">
                            <label for="selectAll" style="margin: 0; font-weight: normal;">„Åô„Åπ„Å¶ÈÅ∏Êäû / Ëß£Èô§</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>„ÉÜ„Éº„Éñ„É´ÈÅ∏Êäû</label>
                        <div class="table-selection">
                            {{if .Tables}}
                            {{range .Tables}}
                            <div class="table-checkbox">
                                <input type="checkbox" name="tables" value="{{.TableName}}" id="table-{{.TableName}}" class="table-check" {{if or (not $.SelectedTable) (eq $.SelectedTable .TableName)}}checked{{end}}>
                                <label for="table-{{.TableName}}" style="margin: 0; font-weight: normal;">üìä {{.TableName}}</label>
                            </div>
                            {{end}}
                            {{else}}
                            <p style="color: #7f8c8d; padding: 1rem;">„ÉÜ„Éº„Éñ„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                            {{end}}
                        </div>
                    </div>

                    <div class="section-title">„Ç®„ÇØ„Çπ„Éù„Éº„ÉàË®≠ÂÆö</div>

                    <div class="form-group">
                        <label for="format">„Éï„Ç©„Éº„Éû„ÉÉ„Éà</label>
                        <select name="format" id="format">
                            <option value="csv">CSV</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="delimiter">Âå∫Âàá„ÇäÊñáÂ≠ó</label>
                        <select name="delimiter" id="delimiter">
                            <option value=",">„Ç´„É≥„Éû (,)</option>
                            <option value=";">„Çª„Éü„Ç≥„É≠„É≥ (;)</option>
                            <option value="\t">„Çø„Éñ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="enclosure">Âõ≤„ÅøÊñáÂ≠ó</label>
                        <select name="enclosure" id="enclosure">
                            <option value='"'>„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„Éà (")</option>
                            <option value="'">„Ç∑„É≥„Ç∞„É´„ÇØ„Ç©„Éº„Éà (')</option>
                            <option value="">„Å™„Åó</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="form-group-inline">
                            <input type="checkbox" name="include_headers" id="include_headers" value="true" checked>
                            <label for="include_headers" style="margin: 0; font-weight: normal;">„Éò„ÉÉ„ÉÄ„ÉºË°å„ÇíÂê´„ÇÅ„Çã</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="encoding">ÊñáÂ≠ó„Ç®„É≥„Ç≥„Éº„Éá„Ç£„É≥„Ç∞</label>
                        <select name="encoding" id="encoding">
                            <option value="utf8">UTF-8</option>
                            <option value="sjis">Shift_JIS</option>
                            <option value="eucjp">EUC-JP</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-success">üì• „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂÆüË°å</button>
                        <a href="/servers/{{.Server.ID}}/database?db={{.CurrentDatabase}}" class="btn">„Ç≠„É£„É≥„Çª„É´</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Toggle all tables
        function toggleAllTables(checkbox) {
            const tableChecks = document.querySelectorAll('.table-check');
            tableChecks.forEach(check => {
                check.checked = checkbox.checked;
            });
        }

        // Toggle server tree
        function toggleServer(event) {
            event.preventDefault();
            event.stopPropagation();

            const databaseList = document.getElementById('server-databases');
            const toggleIcon = event.target;

            if (databaseList.classList.contains('expanded')) {
                databaseList.classList.remove('expanded');
                toggleIcon.textContent = '‚ñ∂';
            } else {
                databaseList.classList.add('expanded');
                toggleIcon.textContent = '‚ñº';
            }
        }

        // Toggle database tree
        function toggleDatabase(event, index) {
            event.preventDefault();
            event.stopPropagation();

            const tableList = document.getElementById('db-' + index);
            const toggleIcon = event.target;

            if (tableList.classList.contains('expanded')) {
                tableList.classList.remove('expanded');
                toggleIcon.textContent = '‚ñ∂';
            } else {
                tableList.classList.add('expanded');
                toggleIcon.textContent = '‚ñº';
            }
        }

        // Resizer functionality
        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('sidebar');
        let isResizing = false;

        resizer.addEventListener('mousedown', function(e) {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;

            const newWidth = e.clientX;
            if (newWidth >= 150 && newWidth <= 600) {
                sidebar.style.width = newWidth + 'px';
            }
        });

        document.addEventListener('mouseup', function(e) {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });
    </script>
</body>
</html>
